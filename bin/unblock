#!/bin/bash

path=$(type -p $0)
path=${path%/*}

. $path/init
. $bindir/loglib
. $bindir/record
. $bindir/block

trap logfinish 0

log $prog

really=1

if [ "$1" = -n ]
then
  really=0
fi

maxage=$(( 24*3600*14 ))
now=$(date +%s)
for addr in $(blocked_before $((now - maxage)) )
do
  if [ $really = 1 ]
  then
    if unblock $addr
    then
      remove_blocked $addr
      # for cron
      stamp=$(block_time $addr)
      echo unblocking $addr, blocked on $(date -d @$stamp)
    else
      log unblock failed
    fi
  else
    log would unblock $addr
  fi
done
