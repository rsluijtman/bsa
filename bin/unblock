#!/bin/bash

path=$(type -p $0)
path=${path%/*}

. $path/init
. $bindir/loglib
. $bindir/record

get_ext(){
  set -- $($ip route list | grep default)
  if [ "$1" = default ]
  then
    echo "$5"
  else
    echo
  fi
}

trap logfinish 0

log $prog

really=1

if [ "$1" = -n ]
then
  really=0
fi 

maxage=$(( 24*3600*14 ))
now=$(date +%s)
ext=$(get_ext)
for addr in $(blocked_before $((now - maxage)) )
do
  # for cron
  stamp=$(blocking_date $addr)
  echo unblocking $addr, blocked on $(date -d @$stamp)

  cmd="$iptables --delete ssh --in-interface $ext --source $addr --jump DROP"
  if [ $really = 1 ]
  then
    remove_blocked $addr
    log "cmd: $cmd"
    $cmd
  else
    log would remove_blocked $addr
    log would $cmd
  fi
done
