#!/bin/bash

path=$(type -p $0)
path=${path%/*}

if [ -z "$path" -o ! -d "$path" ]
then
  echo could not find working dir
  exit 1
fi


. $path/init
. $bindir/loglib
. $bindir/record

trap logfinish 0

maxtries=5

for address in $(noted_addresses)
do
  if [ $(attempts $address) -gt $maxtries ]
  then
. $bindir/block
    if block $address
    then
      mark_blocked $address
    else
      # iptables might be in use, do not mark as blocked, try again next time
      log block $address failed
    fi
  fi
done
