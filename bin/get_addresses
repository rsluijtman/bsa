#!/bin/bash

exec >> /tmp/bsa.log
exec 2>&1
echo untill switching to real logfile

path=$(type -p $0)
path=${path%/*}
[ -z "$path" ] && path='.'
. $path/init

. $bindir/loglib
. $bindir/record

sshrx=$hostname' sshd\[([0-9]+)\]'

iprx='([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})'
eventrx=(
     'sshd\[.* '$iprx' .*\[preauth\]'
     'sshd\[.* Did not receive identification string from '$iprx
     'sshd\[.* User .* from '$iprx' not allowed because not listed in AllowUsers'
     'sshd\[.* Bad protocol version identification .* from '$iprx' port'
     'sshd\[.* Invalid user .* from '$iprx
    )

increasecountrx = (
     'sshd\[.* Failed password for .* from '$iprx' port'
    )

log starting $prog

log starting read loop
while read line
do
  [[ $line =~ $sshrx ]] || continue # { log "no match sshd rx"; continue ; }
  log $line
  sshpid=${BASH_REMATCH[1]}

  for (( i=0 ; i < ${#increasecountrx[*]} ; i++ ))
  do
    if [[ $line =~ ${increasecountrx[$i]} ]]
    then
      record_noted_ip ${BASH_REMATCH[1]}
      continue 2
    fi
  done

  for (( i=0 ; i < ${#eventrx[*]} ; i++ ))
  do
    if [[ $line =~ ${eventrx[$i]} ]]
    then
      record_noted_event ${BASH_REMATCH[1]} $sshpid
      break
    fi 
  done
done
logfinish
